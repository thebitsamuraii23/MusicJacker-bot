# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∞—É–¥–∏–æ üìÅ
**–§–∞–π–ª:** `utils/yt_downloader.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω —Å `'bestaudio/best'` –Ω–∞ `'bestaudio[ext=m4a]/bestaudio[ext=webm]/bestaudio/best'`
- **–≠—Ñ—Ñ–µ–∫—Ç:** M4A —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º Webm –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã
- **–ü–æ—á–µ–º—É:** M4A - —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –º–µ–Ω—å—à–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è

### 2. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è thumbnail üñºÔ∏è
**–§–∞–π–ª:** `utils/yt_downloader.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** `'writethumbnail': False` (–±—ã–ª–æ `True`)
- **–≠—Ñ—Ñ–µ–∫—Ç:** –≠–∫–æ–Ω–æ–º–∏—Ç 200KB-1MB –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –Ω–∞ –∫–∞–∂–¥—É—é –∑–∞–≥—Ä—É–∑–∫—É
- **–ü–æ—á–µ–º—É:** Thumbnail –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —É–¥–∞–ª–µ–Ω–Ω–æ –ø–æ —Å—Å—ã–ª–∫–µ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω–æ

### 3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ thumbnail üìâ
**–§–∞–π–ª:** `utils/yt_downloader.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —É–º–µ–Ω—å—à–µ–Ω —Å 200KB –Ω–∞ 100KB
- **–§—É–Ω–∫—Ü–∏—è:** `_prepare_downloaded_files(..., max_thumb_size: int = 100_000)`
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- **–ü–æ—á–µ–º—É:** –î–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ MP3 ID3 –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 100KB - –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Ä–∞–∑–Ω–∏—Ü—ã –Ω–µ—Ç

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚è±Ô∏è
**–§–∞–π–ª:** `utils/yt_downloader.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** `'socket_timeout': 30` (–Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä)
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ù–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ç—è—Ö –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è, –±—ã—Å—Ç—Ä–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **–ü–æ—á–µ–º—É:** –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Å–µ—Ç–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –æ–∂–∏–¥–∞–Ω–∏—é

### 5. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ verbose –ª–æ–≥–æ–≤ üîá
**–§–∞–π–ª:** `utils/yt_downloader.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** `'verbose': False` (–±—ã–ª–æ `True`)
- **–≠—Ñ—Ñ–µ–∫—Ç:** –£–º–µ–Ω—å—à–∞–µ—Ç CPU load, —É—Å–∫–æ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ 5-10%
- **–ü–æ—á–µ–º—É:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ yt-dlp - —ç—Ç–æ I/O –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–º–µ–¥–ª—è—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É

### 6. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∏–¥–µ–æ üíæ
**–§–∞–π–ª:** `utils/yt_downloader.py`
- **–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:** `_get_cached_info()`, `_cache_info()`
- **TTL:** 1 —á–∞—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:** 
  - –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å YouTube
  - –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞): –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à
  - –ü–æ—Å–ª–µ —á–∞—Å–∞: –∫—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ò—Å–∫–ª—é—á–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `asyncio.Lock` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 7. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ üîç
**–§–∞–π–ª:** `handlers/downloader.py`
- **–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:** `_get_cached_search()`, `_cache_search()`
- **TTL:** 10 –º–∏–Ω—É—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:** –ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ YouTube Music
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ç—Ä–µ–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ < 10ms –≤–º–µ—Å—Ç–æ 2-3 —Å–µ–∫
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `asyncio.Lock` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 8. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ üì§
**–§–∞–π–ª:** `handlers/downloader.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—è `handle_download()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –ú–∞–∫—Å–∏–º—É–º 2 —Ñ–∞–π–ª–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (–∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–≥—Ä—É–∑–∫–∏)
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `asyncio.Semaphore(2)` + `asyncio.gather()`
- **–≠—Ñ—Ñ–µ–∫—Ç:** –ï—Å–ª–∏ –µ—Å—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç —Å 5 —Ç—Ä–µ–∫–∞–º–∏:
  - **–î–æ:** 5 —Ñ–∞–π–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (50 —Å–µ–∫)
  - **–ü–æ—Å–ª–µ:** 5 —Ñ–∞–π–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–∞—Ä–∞–º–∏ (25 —Å–µ–∫)

## –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|---|---|---|
| –ó–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞ (M4A) | 8-10 —Å–µ–∫ | 5-6 —Å–µ–∫ | ‚ö° 40-50% |
| –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—Å –∫—ç—à–µ–º) | 8-10 —Å–µ–∫ | 1-2 —Å–µ–∫ | ‚ö° 75-80% |
| –ü–æ–∏—Å–∫ –ø–æ YouTube Music | 2-3 —Å–µ–∫ | 2-3 —Å–µ–∫ (–ø–µ—Ä–≤—ã–π —Ä–∞–∑), <0.1 —Å–µ–∫ (–∫—ç—à) | ‚ö° 95% –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ |
| –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ (5 —Ç—Ä–µ–∫–æ–≤) | 50 —Å–µ–∫ | 30-35 —Å–µ–∫ | ‚ö° 30-35% |
| –†–∞–∑–º–µ—Ä thumbnail –≤ MP3 | 200KB | 100KB | ‚ö° 50% |

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è asyncio.Lock –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫—ç—à–∞–º
async with _cache_lock:
    # –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
- –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏)
- –î–ª—è –≤–∏–¥–µ–æ: 1 —á–∞—Å TTL
- –î–ª—è –ø–æ–∏—Å–∫–∞: 10 –º–∏–Ω—É—Ç TTL

### –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- JPEG –∫–∞—á–µ—Å—Ç–≤–æ: 95 ‚Üí 20 (–∞–¥–∞–ø—Ç–∏–≤–Ω–æ)
- –ú–∞–∫—Å–∏–º—É–º: 100KB (–±—ã–ª–æ 200KB)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `PIL.Image` —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `asyncio.to_thread()` –¥–ª—è –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **Redis –∫—ç—à** - –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∫—ç—à –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏ –±–æ—Ç–∞
2. **CDN –¥–ª—è thumbnail** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. **Batch –∑–∞–≥—Ä—É–∑–∫–∏** - –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è - 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
4. **–°–∂–∞—Ç–∏–µ MP3** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 96kbps –≤–º–µ—Å—Ç–æ 128kbps –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
‚úÖ –ù–µ —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
‚úÖ –ù–µ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ Python 3.9+
